%% read_file
% This function is used in the batch mode to read the file containing the
% instruction to execute.
%
% parameters = read_file(dataFile)
%
% input:
%   dataFile is the name of the file (with its path) which contains all the
%       instructions to execute
%
% output:
%   parameters is a cell array which contains all the parameters which have
%       to be used in batch analysis (in order, dataPath, fs, cf, epNum, 
%       epTime, tStart, totBand, measure, Subjects, locations, Index, 
%       MeasureExtraction, EpochsAverage, EpochsAnalysis, IndexCorrelation,
%       StatisticalAnalysis, MeasuresCorrelation, ClassificationData, 
%       Group_IC, Areas_IC, Conservativeness_IC, Areas_EA, Areas_SA, 
%       Conservativeness_SA, Measure1, Measure2, Areas_MC, Group_MC,
%       MergingData, DataType, MergingMeasures, MergingAreas, Subject, 
%       Classification, ClassificationData, DefaultClassification, 
%       TrainPercentage, TreesNumber, FResampleValue, Pruning, 
%       Repetitions, MinimumClassExamples, PCAValue)
%       ScatterAnalysis, Scatter_Measure1, Scatter_Measure2, Scatter_Band1,
%       Scatter_Band2, Scatter_Location1, Scatter_Location2

function parameters = read_file(dataFile)
    
    params_names = {'dataPath=', 'fs=', 'cf=', 'epNum=', 'epTime=', ...
        'tStart=', 'totBand=', 'measures=', 'Subjects=', 'Locations=', ...
        'Index=', 'MeasureExtraction=', 'EpochsAverage=', ...
        'EpochsAnalysis=', 'IndexCorrelation=', 'StatisticalAnalysis=', ...
        'MeasuresCorrelation=', 'ClassificationData=', 'Group_IC=', ...
        'Areas_IC=', 'Conservativeness_IC=', 'Areas_EA=', 'Areas_SA=', ...
        'Conservativeness_SA=', 'Measure1=', 'Measure2=', 'Areas_MC=', ...
        'Group_MC=', 'MergingData=', 'MergingMeasures=', ...
        'MergingAreas=', 'Subject=', 'RF_Classification=', ...
        'DataType', 'RF_DefaultClassificationParameters=', ...
        'RF_TrainPercentage=', 'RF_TreesNumber=', 'RF_FResampleValue=', ...
        'RF_Pruning=', 'RF_Repetitions=', 'RF_MinimumClassExamples=', ...
        'RF_PCAValue=', 'RF_Evaluation=', 'RF_Rejection=', ...
        'NN_Classification=', 'NN_DefaultClassificationParameters=', ...
        'NN_TrainPercentage=', 'NN_HiddenLayersNumber=', ...
        'NN_ValidationValue=', 'NN_Repetitions=', ...
        'NN_MinimumClassExamples=', 'NN_PCAValue=', 'NN_Evaluation=', ...
        'NN_Rejection=' };
    n_params = length(params_names);
    pre_parameters = cell(n_params, 1);
    
    aux_cases = 1:n_params;
    par_cases = {aux_cases(contains(params_names, 'Conservativeness'))};
    par_cases = [par_cases, [aux_cases(contains(params_names, 'fs')), ...
        aux_cases(contains(params_names, 'epNum')), ...
        aux_cases(contains(params_names, 'epTime')), ...
        aux_cases(contains(params_names, 'tStart')), ...
        aux_cases(contains(params_names, 'RF_Repetitions')), ...
        aux_cases(contains(params_names, 'RF_MinimumClassExamples')), ...
        aux_cases(contains(params_names, 'RF_TrainPercentage')), ...
        aux_cases(contains(params_names, 'RF_TreesNumber')), ...
        aux_cases(contains(params_names, 'MergingAreas')), ...
        aux_cases(contains(params_names, 'RF_FResampleValue')), ...
        aux_cases(contains(params_names, 'RF_PCAValue')), ...
        aux_cases(contains(params_names, 'RF_Rejection')), ...
        aux_cases(contains(params_names, 'NN_Repetitions')), ...
        aux_cases(contains(params_names, 'NN_MinimumClassExamples')), ...
        aux_cases(contains(params_names, 'NN_TrainPercentage')), ...
        aux_cases(contains(params_names, 'NN_HiddenLayersNumber')), ...
        aux_cases(contains(params_names, 'NN_ValidationValue')), ...
        aux_cases(contains(params_names, 'NN_PCAValue')), ...
        aux_cases(contains(params_names, 'NN_Rejection'))]];
    par_cases = [par_cases, ...
        [aux_cases(contains(params_names, 'measures')), ...
        aux_cases(contains(params_names, 'Areas_')), ...
        aux_cases(contains(params_names, 'Group_')), ...
        aux_cases(contains(params_names, 'MergingMeasures')), ...
        aux_cases(contains(params_names, 'MergingAreas')), ...
        aux_cases(contains(params_names, 'totBand'))]];
    cf = 3;
    par_functions = {@cons_check, @str2double, @split};
    
    
    auxID = fopen(dataFile, 'r');
    fseek(auxID, 0, 'bof');
    while ~feof(auxID)
        prop = fgetl(auxID);
        for i = 1:n_params
            if contains(prop, params_names{i})
                aux_par = split(prop, '=');
                aux_par = aux_par{2};
                if contains(prop, 'cf=')
                    aux_par = str2double(split(aux_par))';
                    pre_parameters{cf} = aux_par(1:end-1);
                else
                    check = 0;
                    for j = 1:length(par_functions)
                        if not(isempty(find(par_cases{j} == i)))
                            p_f = par_functions{j};
                            pre_parameters{i} = p_f(aux_par);
                            check = 1;
                        end
                    end
                    if check == 0
                        pre_parameters{i} = aux_par;
                    end
                end
            end
        end
    end
    fclose(auxID);
    
    % dataPath 1, fs 2, cf 3, epNum 4, epTime 5, tStart 6, totBand 7, 
    % measure 8, Subjects 9, locations 10, Index 11, MeasureExtraction 12, 
    % EpochsAverage 13, EpochsAnalysis 14, IndexCorrelation 15, 
    % StatisticalAnalysis 16, MeasuresCorrelation 17, 
    % ClassificationData 18, Group_IC 19, Areas_IC 20, 
    % Conservativeness_IC 21, Areas_EA 22, Areas_SA 23, 
    % Conservativeness_SA 24, Measure1 25, Measure2 26, Areas_MC 27, 
    % Group_MC 28, MergingData 29, MergingMeasures 30, MergingAreas 31, 
    % Subject 32, RF_Classification 33, DataType 34, 
    % RF_DefaultClassification 35, RF_TrainPercentage 36, 
    % RF_TreesNumber 37, RF_FResampleValue 38, RF_Pruning 39, 
    % RF_Repetitions 40, RF_MinimumClassExamples 41, RF_PCAValue 42, 
    % RF_Evaluation 43, RF_Rejection 44, NN_Classification 45, 
    % NN_DefaultClassificationParameters 46, NN_TrainPercentage 47, 
    % NN_HiddenLayersNumber 48, NN_ValidationValue 49, NN_Repetitions 50, 
    % NN_MinimumClassExamples 51, NN_PCAValue 52, NN_Evaluation 53,
    % NN_Rejection 54
    
    n = length(pre_parameters)*2;
    parameters = cell(1, n);
    for i = 1:2:n
        idx = floor(i/2)+1;
        name = char_check(params_names{idx});
        parameters{i} = string(name(1:end-1));
        parameters{i+1} = pre_parameters{idx};
    end
end